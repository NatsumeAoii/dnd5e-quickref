<!DOCTYPE html>
<html lang="en" data-theme="original" data-mode="light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security Hardening: CSP with Trusted Types & Permissions Policy -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; require-trusted-types-for 'script';">
    <meta http-equiv="Permissions-Policy"
        content="geolocation=(), microphone=(), camera=(), payment=(), usb=(), vr=(), accelerometer=(), gyroscope=(), magnetometer=()">

    <title>D&D5e QuickRef</title>

    <meta name="description"
        content="A quick, searchable reference guide for Dungeons & Dragons 5th Edition (D&D 5e) rulesets." />
    <meta name="author" content="Natsumee" />
    <meta name="theme-color" content="#802b1c" />

    <link rel="icon" type="image/png" href="img/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="img/favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="5e Quickref" />
    <link rel="manifest" href="manifest.json" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

    <link rel="preload" href="css/quickref.css" as="style">
    <link rel="stylesheet" href="css/quickref.css">

    <link id="theme-stylesheet" rel="stylesheet" type="text/css" href="">
    <link rel="stylesheet" type="text/css" href="css/icons.css">
    <style>
        /* Critical CSS for skeleton loader */
        .skeleton-loader {
            max-width: 2000px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        .skeleton-section {
            height: 60px;
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius-lg);
            margin-bottom: 0.5rem;
            opacity: 0.5;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                background-color: var(--color-card-bg);
            }

            50% {
                background-color: var(--color-border);
            }

            100% {
                background-color: var(--color-card-bg);
            }
        }

        /* Error Boundary Styles */
        #global-error-boundary {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            z-index: 20000;
            padding: 2rem;
            text-align: center;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #global-error-boundary.visible {
            display: flex;
        }

        .error-actions {
            margin-top: 1rem;
        }
    </style>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const el = document.getElementById('global-error-boundary');
            const txt = document.getElementById('error-text');
            if (el && txt) {
                el.classList.add('visible');
                txt.textContent = msg;
            }
            return false;
        };
    </script>
</head>

<body>
    <div id="global-error-boundary" role="alert">
        <h1>Something went wrong</h1>
        <p>We encountered an unexpected error.</p>
        <code id="error-text"
            style="background: #333; color: #fff; padding: 0.5rem; border-radius: 4px; display: block; margin: 1rem 0; max-width: 100%; overflow: auto;"></code>
        <div class="error-actions">
            <button onclick="window.location.reload()">Reload Page</button>
            <button onclick="localStorage.clear(); sessionStorage.clear(); window.location.reload()">Factory
                Reset</button>
        </div>
    </div>

    <div id="notification-container"></div>
    <div id="aria-announcer" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

    <div id="skeleton-loader" class="skeleton-loader" aria-hidden="true">
        <div class="skeleton-section"></div>
        <div class="skeleton-section"></div>
        <div class="skeleton-section"></div>
        <div class="skeleton-section"></div>
        <div class="skeleton-section"></div>
    </div>

    <div id="app-container" class="app-container hidden">
        <main class="page" id="main-scroll-area">
            <section id="section-favorites" class="section-container hidden" data-section="favorites">
                <h2 class="section-title">
                    <span>Favorites</span>
                    <span class="section-title-subtitle">Your quick access rules (Drag to reorder)</span>
                </h2>
                <div class="section-content">
                    <div class="section-row" id="favorites-container"></div>
                    <p class="section-subtitle" id="favorites-placeholder">
                        Click the star icon on any rule to add it to your favorites.
                    </p>
                </div>
            </section>

            <section id="section-movement" class="section-container" data-section="movement">
                <h2 class="section-title">
                    <span>Movement</span>
                    <span class="section-title-subtitle">limited by movement speed</span>
                </h2>
                <div class="section-content" data-rendered="false">
                    <p class="section-subtitle">
                        You can move at any time during your turn (before, after, or during actions).
                    </p>
                    <div class="section-row" id="basic-movement"></div>
                </div>
            </section>

            <section id="section-action" class="section-container" data-section="action">
                <h2 class="section-title">
                    <span>Action</span>
                    <span class="section-title-subtitle">1/turn</span>
                </h2>
                <div class="section-content" data-rendered="false">
                    <p class="section-subtitle">
                        You can also interact with one object or feature of the environment for free.
                    </p>
                    <div class="section-row" id="basic-actions"></div>
                </div>
            </section>

            <section id="section-bonus-action" class="section-container" data-section="bonus-action">
                <h2 class="section-title">
                    <span>Bonus action</span>
                    <span class="section-title-subtitle">max. 1/turn</span>
                </h2>
                <div class="section-content" data-rendered="false">
                    <p class="section-subtitle">
                        You can take a bonus action only when a special ability, spell, or feature states that you can
                        do something as a bonus action.
                    </p>
                    <div class="section-row" id="basic-bonus-actions"></div>
                </div>
            </section>

            <section id="section-reaction" class="section-container" data-section="reaction">
                <h2 class="section-title">
                    <span>Reaction</span>
                    <span class="section-title-subtitle">max. 1/round</span>
                </h2>
                <div class="section-content" data-rendered="false">
                    <p class="section-subtitle">
                        A reaction is an instant response to a trigger of some kind, which can occur on your turn or on
                        someone else's.
                    </p>
                    <div class="section-row" id="basic-reactions"></div>
                </div>
            </section>

            <section id="section-condition" class="section-container" data-section="condition">
                <h2 class="section-title">
                    <span>Condition</span>
                </h2>
                <div class="section-content" data-rendered="false">
                    <p class="section-subtitle">
                        Conditions alter your capabilities in a variety of ways, and can arise as a result of a spell, a
                        class feature, a monster's attack, or other effect.
                    </p>
                    <div class="section-row" id="basic-conditions"></div>
                </div>
            </section>

            <section id="section-environment" class="section-container" data-section="environment">
                <h2 class="section-title">
                    <span>Environmental Effects</span>
                </h2>
                <div class="section-content" data-rendered="false">
                    <p class="section-subtitle">
                        Effects that obscure vision can prove a significant hindrance to most adventuring tasks.
                    </p>
                    <div class="section-row" id="environment-obscurance"></div>
                    <p class="section-subtitle">
                        The presence or absence of light in an environment creates three categories of illumination.
                    </p>
                    <div class="section-row" id="environment-light"></div>
                    <p class="section-subtitle">
                        Some creatures have extraordinary senses that allow them to perceive their environment.
                    </p>
                    <div class="section-row" id="environment-vision"></div>
                    <p class="section-subtitle">
                        Obstacles can provide cover during combat, making a target more difficult to harm.
                    </p>
                    <div class="section-row" id="environment-cover"></div>
                    <p class="section-subtitle">
                        Adventurers may also face a variety of environmental hazards and hidden dangers.
                    </p>
                    <div class="section-row" id="environment-other"></div>
                </div>
            </section>

            <section id="section-settings" class="section-container" data-section="settings">
                <h2 class="section-title">
                    <span>Settings & Accessibility</span>
                </h2>
                <div class="section-content">
                    <h3 class="settings-row-title">Content Rulesets</h3>
                    <p class="section-subtitle">Control which rule sets are displayed throughout the application.</p>
                    <div class="section-row">
                        <label class="item itemsize" for="optional-switch" title="Include Optional Rules"
                            data-filterable="false">
                            <div class="item-text-container">
                                <div class="item-title">Include Optional Rules (*)</div>
                                <div class="item-desc">Show/hide optional rules from DMG.</div>
                            </div>
                            <div class="item-control-container">
                                <span class="switch">
                                    <input type="checkbox" id="optional-switch">
                                    <span class="slider round"></span>
                                </span>
                            </div>
                        </label>
                        <label class="item itemsize" for="homebrew-switch" title="Include Homebrew Rules"
                            data-filterable="false">
                            <div class="item-text-container">
                                <div class="item-title">Include Homebrew Rules (**)</div>
                                <div class="item-desc">Show/hide most common Homebrew rules.</div>
                            </div>
                            <div class="item-control-container">
                                <span class="switch">
                                    <input type="checkbox" id="homebrew-switch">
                                    <span class="slider round"></span>
                                </span>
                            </div>
                        </label>
                        <label class="item itemsize" for="rules2024-switch" title="Switch to 2024 Rules"
                            data-filterable="false">
                            <div class="item-text-container">
                                <div class="item-title">Use 2024 Rules</div>
                                <div class="item-desc">Enable D&D 2024 Rules (reloads page).</div>
                            </div>
                            <div class="item-control-container">
                                <span class="switch">
                                    <input type="checkbox" id="rules2024-switch">
                                    <span class="slider round"></span>
                                </span>
                            </div>
                        </label>
                    </div>
                    <hr>
                    <h3 class="settings-row-title">Appearance & Accessibility</h3>
                    <p class="section-subtitle">Customize the application's look, feel, and behavior.</p>
                    <div class="section-row">
                        <div class="item itemsize" data-filterable="false">
                            <div class="item-text-container">
                                <label for="theme-select" class="item-title" id="theme-label">Color Theme</label>
                                <div class="item-desc">Change the application's appearance.</div>
                            </div>
                            <div class="item-control-container">
                                <select id="theme-select" aria-labelledby="theme-label"></select>
                            </div>
                        </div>
                        <label class="item itemsize" for="mode-switch" title="Toggle Dark Mode" data-filterable="false">
                            <div class="item-text-container">
                                <div class="item-title">Dark Mode</div>
                                <div class="item-desc">Switch between light and dark modes.</div>
                            </div>
                            <div class="item-control-container">
                                <span class="switch">
                                    <input type="checkbox" id="mode-switch">
                                    <span class="slider round"></span>
                                </span>
                            </div>
                        </label>
                        <label class="item itemsize" for="reduce-motion-switch" title="Reduce Motion"
                            data-filterable="false">
                            <div class="item-text-container">
                                <div class="item-title">Reduce Motion</div>
                                <div class="item-desc">Disable animations and transitions.</div>
                            </div>
                            <div class="item-control-container">
                                <span class="switch">
                                    <input type="checkbox" id="reduce-motion-switch">
                                    <span class="slider round"></span>
                                </span>
                            </div>
                        </label>
                        <label class="item itemsize" for="wakelock-switch" title="Keep Screen On"
                            data-filterable="false">
                            <div class="item-text-container">
                                <div class="item-title">Keep Screen On</div>
                                <div class="item-desc">Prevent screen from sleeping while active.</div>
                            </div>
                            <div class="item-control-container">
                                <span class="switch">
                                    <input type="checkbox" id="wakelock-switch">
                                    <span class="slider round"></span>
                                </span>
                            </div>
                        </label>
                    </div>
                    <hr>
                    <h3 class="settings-row-title">Data Management</h3>
                    <div class="section-row">
                        <div class="item itemsize" role="button" tabindex="0" id="export-notes-btn">
                            <div class="item-text-container">
                                <div class="item-title">Export Notes</div>
                                <div class="item-desc">Download your notes (Compressed JSON).</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="site-footer" id="site-footer">
                <div class="footer-content">
                    <div class="footer-column footer-column-left">
                        <p>
                            <a href="https://github.com/NatsumeAoii/dnd5e-quickref" target="_blank"
                                rel="noopener noreferrer" class="github-link">View on GitHub</a>
                        </p>
                        <p class="footer-message">A quick reference tool for Dungeons & Dragons 5th Edition players and
                            Dungeon Masters.</p>
                        <p class="copyright">
                            &copy; <span id="copyright-year"></span> D&D 5e Quick Ref contributors. All Rights Reserved.
                        </p>
                        <p>
                            <button id="report-rule-btn" class="footer-report-btn">Report missing or incorrect
                                rules</button>
                        </p>
                    </div>

                    <div class="footer-column footer-column-right">
                        <h4 class="footer-links-title">Other Tools</h4>
                        <div class="footer-links-container">
                            <div class="footer-links-group">
                                <h5>GM/DM Related</h5>
                                <ul class="footer-links-list">
                                    <li><a href="https://5e.tools/" target="_blank"
                                            rel="noopener noreferrer">5e.tools</a></li>
                                    <li><a href="https://donjon.bin.sh/" target="_blank"
                                            rel="noopener noreferrer">donjon</a></li>
                                </ul>
                            </div>
                            <div class="footer-links-group">
                                <h5>Map Makers</h5>
                                <ul class="footer-links-list">
                                    <li><a href="https://dungeonscrawl.com/" target="_blank"
                                            rel="noopener noreferrer">Dungeon Scrawl (Free)</a></li>
                                    <li><a href="https://inkarnate.com/" target="_blank"
                                            rel="noopener noreferrer">Inkarnate (Free/Pro)</a></li>
                                </ul>
                            </div>
                            <div class="footer-links-group">
                                <h5>For Playing</h5>
                                <ul class="footer-links-list">
                                    <li><a href="https://www.dndbeyond.com/" target="_blank"
                                            rel="noopener noreferrer">D&D Beyond</a></li>
                                    <li><a href="https://roll20.net/" target="_blank"
                                            rel="noopener noreferrer">Roll20</a></li>
                                    <li><a href="https://foundryvtt.com/" target="_blank"
                                            rel="noopener noreferrer">Foundry VTT</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <div id="popup-container"></div>

    <div id="cookie-notice" class="cookie-notice" role="dialog" aria-labelledby="cookie-notice-title"
        aria-describedby="cookie-notice-text">
        <div class="cookie-notice-content">
            <h3 id="cookie-notice-title" class="cookie-notice-title">Your Privacy</h3>
            <p id="cookie-notice-text" class="cookie-notice-text">
                This website uses local storage to save your preferences and settings. By clicking "Accept", you agree
                to this practice.
            </p>
            <div class="cookie-notice-actions">
                <button id="remind-cookies-later" class="cookie-notice-secondary-btn">Remind Me Later</button>
                <button id="accept-cookies">Accept</button>
            </div>
        </div>
    </div>

    <button id="close-all-popups-btn" title="Close All Popups" aria-label="Close All Popups">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true" viewBox="0 0 24 24">
            <path
                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" />
        </svg>
    </button>

    <template id="rule-item-template">
        <div class="item itemsize">
            <div class="item-content" role="button" tabindex="0">
                <div class="item-icon iconsize"></div>
                <div class="item-text-container">
                    <div class="item-title"></div>
                    <div class="item-desc"></div>
                </div>
            </div>
            <button class="favorite-btn" aria-label="Toggle Favorite" title="Toggle Favorite">
                <span aria-hidden="true">&#9733;</span>
            </button>
        </div>
    </template>

    <template id="popup-template">
        <dialog class="popup-window">
            <header class="popup-header">
                <span class="popup-title"></span>
                <div class="popup-header-right">
                    <span class="popup-type"></span>
                    <button class="popup-close-btn" title="Close" aria-label="Close">&times;</button>
                </div>
            </header>
            <div class="popup-content" tabindex="-1">
                <p class="section-subtitle popup-description"></p>
                <p class="popup-summary"></p>
                <div class="popup-bullets hidden"></div>
                <div class="popup-reference-container">
                    <p class="popup-reference hidden"></p>
                    <button class="popup-toggle-details-btn" aria-expanded="false">Tell Me More</button>
                </div>
                <div class="popup-notes-container">
                    <hr>
                    <div class="popup-notes-header">
                        <label class="popup-notes-label">Your Notes</label>
                        <span class="popup-notes-status" aria-live="polite"></span>
                    </div>
                    <textarea class="popup-notes-textarea"
                        placeholder="Add personal notes, house rules, etc."></textarea>
                </div>
            </div>
        </dialog>
    </template>

    <script type="module" src="js/quickref.js" defer></script>
</body>

</html>